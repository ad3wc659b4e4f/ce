name: Force Sync & Unlock Features

# ã€å…³é”®ä¿®å¤ã€‘æ˜ç¡®ç”³è¯·ä¿®æ”¹ Workflows çš„æƒé™
permissions:
  contents: write
  workflows: write

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  unlock_features:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Reset to Upstream
        run: |
          git config --global user.name 'Antigravity Bot'
          git config --global user.email 'bot@noreply.github.com'
          git remote add upstream https://github.com/PCL-Community/PCL2-CE.git
          git fetch upstream dev
          git reset --hard upstream/dev

      - name: ğŸ”“ Apply Unlock Patch (Python)
        shell: python
        run: |
          import os
          import re

          print("ğŸ”§ Starting Agentic Patching...")

          # 1. å®šä¹‰è·¯å¾„
          path_main = "Plain Craft Launcher 2/FormMain.xaml.vb"
          path_base = "Plain Craft Launcher 2/Modules/Base/ModBase.vb"
          path_launch = "Plain Craft Launcher 2/Modules/Minecraft/ModLaunch.vb"
          path_profile = "Plain Craft Launcher 2/Modules/Minecraft/ModProfile.vb"

          # 2. æ³¨å…¥ GetCoR (ModBase.vb)
          try:
              if os.path.exists(path_base):
                  with open(path_base, "r", encoding="utf-8-sig") as f:
                      content = f.read()
                  
                  if "Public Sub GetCoR()" not in content:
                      print("  -> Injecting GetCoR into ModBase.vb...")
                      cor_logic = '''
              Public IsRestrictedFeatAllowed As Boolean = False
              \'\'\' <summary>
              \'\'\' è·å–åŒºåŸŸé™åˆ¶çŠ¶æ€ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å…è®¸ä½¿ç”¨éƒ¨åˆ†åŒºåŸŸé™åˆ¶åŠŸèƒ½ã€‚
              \'\'\' </summary>
              Public Sub GetCoR()
                  If TimeZoneInfo.Local.Id = "China Standard Time" AndAlso
                      (CultureInfo.CurrentCulture.Name = "zh-CN" OrElse CultureInfo.CurrentUICulture.Name = "zh-CN") Then IsRestrictedFeatAllowed = True
              End Sub
                      '''
                      # æ’å…¥åœ¨ Uuid å˜é‡å®šä¹‰ä¹‹å‰ï¼ˆæ¯”è¾ƒç¨³çš„ä½ç½®ï¼‰
                      content = content.replace("    Private Uuid As Integer = 1", cor_logic + "\n    Private Uuid As Integer = 1")
                      with open(path_base, "w", encoding="utf-8-sig") as f:
                          f.write(content)
              else:  print(f"âš ï¸ File not found: {path_base}")
          except Exception as e:
              print(f"âš ï¸ Error patching ModBase: {e}")

          # 3. è°ƒç”¨ GetCoR (FormMain.xaml.vb)
          try:
              if os.path.exists(path_main):
                  with open(path_main, "r", encoding="utf-8-sig") as f:
                      content = f.read()
                  if "GetCoR()" not in content:
                      print("  -> Injecting GetCoR call into FormMain...")
                      content = content.replace("GetSystemInfo()", "GetCoR() 'è·å–åŒºåŸŸé™åˆ¶çŠ¶æ€\n            GetSystemInfo()")
                      with open(path_main, "w", encoding="utf-8-sig") as f:
                          f.write(content)
              else: print(f"âš ï¸ File not found: {path_main}")
          except Exception as e:
              print(f"âš ï¸ Error patching FormMain: {e}")

          # 4. è§£é”æ­£ç‰ˆé™åˆ¶ (ModLaunch.vb)
          try:
              if os.path.exists(path_launch):
                  with open(path_launch, "r", encoding="utf-8-sig") as f:
                      content = f.read()
                  
                  # æŸ¥æ‰¾é‚£æ®µâ€œMyMsgBox...ä½ å¿…é¡»å…ˆç™»å½•æ­£ç‰ˆâ€
                  # æˆ‘ä»¬ç›´æ¥æŠŠå®ƒæ›¿æ¢æˆä¸€ä¸ª Pass é€»è¾‘ï¼Œæˆ–è€…è¿˜åŸè€çš„æé†’é€»è¾‘
                  strict_check_pattern = r'Select Case MyMsgBox\("ä½ å¿…é¡»å…ˆç™»å½•æ­£ç‰ˆè´¦å·æ‰èƒ½å¯åŠ¨æ¸¸æˆï¼".+?End Select'
                  
                  if re.search(strict_check_pattern, content, re.DOTALL):
                      print("  -> Removing strict launch restriction in ModLaunch.vb...")
                      
                      # æ›¿æ¢é€»è¾‘ï¼šåªåœ¨é™åˆ¶åŒºåŸŸä¸”åˆ¤å®šä¸ºè¯•ç©æ—¶æç¤ºï¼Œä½†å…è®¸å¯åŠ¨
                      old_logic = '''
                      If IsRestrictedFeatAllowed Then
                          RunInNewThread(Sub() 
                              'Simplified nag logic: åªè¦ä¸æŠ›å‡ºå¼‚å¸¸ throw å°±èƒ½å¯åŠ¨
                              If Setup.Get("SystemLaunchCount") Mod 50 = 0 Then
                                   MyMsgBox("å¦‚æœè§‰å¾— Minecraft è¿˜ä¸é”™ï¼Œå¯ä»¥è´­ä¹°æ­£ç‰ˆæ”¯æŒä¸€ä¸‹ï¼", "æ”¯æŒæ­£ç‰ˆ", "ç¡®å®š")
                              End If
                          End Sub, "Buy Minecraft")
                      Else
                          'Fallthrough
                      End If
                      '''
                      content = re.sub(strict_check_pattern, old_logic, content, flags=re.DOTALL)
                      
                      # é¡ºä¾¿è®¾ç½® HintBuy é˜²æ­¢å…¶ä»–åœ°æ–¹å¼¹çª—
                      content = content.replace('ProfileLog("æ­£ç‰ˆéªŒè¯å®Œæˆ")', 'ProfileLog("æ­£ç‰ˆéªŒè¯å®Œæˆ")\n        Setup.Set("HintBuy", True)')
                      
                      with open(path_launch, "w", encoding="utf-8-sig") as f:
                          f.write(content)
                  else:
                      print("  -> Strict restriction not found (already patched?)")
              else: print(f"âš ï¸ File not found: {path_launch}")
          except Exception as e:
              print(f"âš ï¸ Error patching ModLaunch: {e}")

          # 5. æ¢å¤ç¦»çº¿ç™»å½•é€‰é¡¹ (ModProfile.vb)
          try:
              if os.path.exists(path_profile):
                  with open(path_profile, "r", encoding="utf-8-sig") as f:
                      content = f.read()
                  
                  # æ‰¾åˆ°è¢«é˜‰å‰²çš„åˆ—è¡¨å®šä¹‰
                  if 'If ProfileList.Any(Function(x) x.Type = McLoginType.Ms) Then' in content:
                      print("  -> Unlocking Login Options in ModProfile.vb...")
                      
                      full_list_code = '''
                          Dim authTypeList As New List(Of IMyRadio) From {
                              New MyListItem With { .Title = "æ­£ç‰ˆéªŒè¯", .Type = MyListItem.CheckType.RadioBox, .Logo = Logo.IconButtonAuth },
                              New MyListItem With { .Title = "ç¬¬ä¸‰æ–¹éªŒè¯", .Type = MyListItem.CheckType.RadioBox, .Logo = Logo.IconButtonThirdparty },
                              New MyListItem With { .Title = "ç¦»çº¿éªŒè¯", .Type = MyListItem.CheckType.RadioBox, .Logo = Logo.IconButtonOffline }
                          }
                          ' Bypass the IF check completely
                          If False Then
                      '''
                      
                      # æ›¿æ¢å¼€å§‹éƒ¨åˆ†
                      content = content.replace('Dim authTypeList As List(Of IMyRadio)', full_list_code)
                      # é—­åˆé‚£ä¸ª If False ä»¥åæ‰åŸæœ‰çš„é€»è¾‘
                      content = content.replace('selectedAuthTypeNum = MyMsgBoxSelect(authTypeList', 'End If\n                        selectedAuthTypeNum = MyMsgBoxSelect(authTypeList')
                      
                      with open(path_profile, "w", encoding="utf-8-sig") as f:
                          f.write(content)
              else: print(f"âš ï¸ File not found: {path_profile}")
          except Exception as e:
              print(f"âš ï¸ Error patching ModProfile: {e}")
              
          print("âœ… Patching Process Complete.")

      - name: Commit and Push
        run: |
          git add .
          git commit -m "chore: unlock features (Agentic-Patch)" || echo "No changes to commit"
          git push -f origin dev
